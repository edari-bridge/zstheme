import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { dirname } from 'path';
import { PATHS } from './config.js';
import { parseThemeContract } from './themeContract.js';
import { RAINBOW_COLORS, LSD_COLORS, MONO_CYCLE } from '../renderer/palette.js';

// ì „ê²½ìƒ‰ ê¸°ë³¸ê°’
// 2line ì‹œê° ìˆœì„œ: Line1(BRANCH,TREE,DIR,STATUS,SYNC) Line2(MODEL,RATE,TIME,BURN)
// CTXëŠ” contextPctì— ì˜í•œ ê³ ì •ê°’ì´ë¯€ë¡œ í¸ì§‘ ëŒ€ìƒ ì•„ë‹˜
export const FG_DEFAULTS = {
  C_BRANCH: { name: 'Branch', code: 11 },
  C_TREE: { name: 'Worktree', code: 10 },
  C_DIR: { name: 'Directory', code: 14 },
  C_STATUS: { name: 'Status', code: 111 },
  C_SYNC: { name: 'Sync', code: 141 },
  C_MODEL: { name: 'Model', code: 13 },
  C_RATE: { name: 'Rate', code: 229 },
  C_TIME: { name: 'Time', code: 75 },
  C_BURN: { name: 'Burn', code: 216 },
};

// badgesìš© ë°°ê²½ìƒ‰ ê¸°ë³¸ê°’ (ê°œë³„ ìš”ì†Œ)
export const BG_BADGES_DEFAULTS = {
  C_BG_BRANCH: { name: 'BG Branch', code: 58 },
  C_BG_TREE: { name: 'BG Worktree', code: 22 },
  C_BG_DIR: { name: 'BG Dir', code: 23 },
  C_BG_STATUS: { name: 'BG Status', code: 24 },
  C_BG_SYNC: { name: 'BG Sync', code: 53 },
  C_BG_MODEL: { name: 'BG Model', code: 53 },
  C_BG_RATE: { name: 'BG Rate', code: 58 },
  C_BG_TIME: { name: 'BG Time', code: 24 },
  C_BG_BURN: { name: 'BG Burn', code: 94 },
};

// barsìš© ë°°ê²½ìƒ‰ ê¸°ë³¸ê°’ (ê·¸ë£¹)
export const BG_BARS_DEFAULTS = {
  C_BG_LOC: { name: 'BG Location', code: 23 },
  C_BG_GIT: { name: 'BG Git', code: 24 },
  C_BG_SES: { name: 'BG Session', code: 53 },
};

// ì•„ì´ì½˜ ì •ì˜
export const ICONS = {
  emoji: {
    BRANCH: 'ğŸ”±',
    TREE: 'ğŸŒ¿',
    DIR: 'ğŸ“‚',
    STATUS: 'ğŸ’¾',
    SYNC: 'ğŸ”®',
    MODEL: 'ğŸ§ ',
    TIME: 'â³',
    SESSION: 'ğŸ’¬',
    COST: 'ğŸ’°',
    THEME: 'ğŸ¨',
    CTX: 'ğŸ”‹',
  },
  nerd: {
    BRANCH: 'ó°˜¬ ',
    TREE: 'ó°™… ',
    DIR: 'ó°° ',
    STATUS: 'ó°Š¤ ',
    SYNC: 'ó°“¦ ',
    MODEL: 'ó°š© ',
    TIME: 'ó°… ',
    SESSION: 'ó°­» ',
    COST: 'ó°†¼ ',
    THEME: 'ó°‰¼ ',
    CTX: 'ó°¹ ',
  }
};

// ë°°ê²½ìƒ‰ì´ í•„ìš”í•œ ë ˆì´ì•„ì›ƒ
export const LAYOUTS_WITH_BG = ['bars', 'badges'];

// í›„ë°© í˜¸í™˜ì„±: BG_DEFAULTSëŠ” BG_BADGES_DEFAULTSì˜ ë³„ì¹­
export const BG_DEFAULTS = BG_BADGES_DEFAULTS;

/**
 * ì»¤ìŠ¤í…€ ìƒ‰ìƒ ë¡œë“œ
 * ì°¸ê³ : layout/iconTypeì€ í”„ë¦¬ë·° ì „ìš©ì´ë¯€ë¡œ í•­ìƒ ê¸°ë³¸ê°’(2line/nerd) ë°˜í™˜
 */
export function loadCustomColors() {
  const fg = {};
  const bgBadges = {};
  const bgBars = {};
  // í˜„ì¬ í™œì„± í…Œë§ˆì—ì„œ layout/icon ê°ì§€ (ë¯¸ì„¤ì • ì‹œ 2line-nerd ê¸°ë³¸)
  let currentTheme = '2line';
  if (existsSync(PATHS.themeConfig)) {
    try {
      const content = readFileSync(PATHS.themeConfig, 'utf-8');
      const match = content.match(/CLAUDE_THEME="([^"]+)"/);
      if (match) currentTheme = match[1];
    } catch { /* use default */ }
  }
  const parsed = parseThemeContract(currentTheme);
  const layout = parsed.layout || '2line';
  const iconType = parsed.icon || 'nerd';

  // ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
  for (const [key, val] of Object.entries(FG_DEFAULTS)) {
    fg[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BADGES_DEFAULTS)) {
    bgBadges[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BARS_DEFAULTS)) {
    bgBars[key] = val.code;
  }

  // ì»¤ìŠ¤í…€ íŒŒì¼ì´ ìˆìœ¼ë©´ ìƒ‰ìƒë§Œ ë¡œë“œ
  if (existsSync(PATHS.customColor)) {
    try {
      const content = readFileSync(PATHS.customColor, 'utf-8');

      // ì „ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(FG_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          fg[key] = parseInt(match[1], 10);
        }
      }

      // badgesìš© ë°°ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(BG_BADGES_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          bgBadges[key] = parseInt(match[1], 10);
        }
      }

      // barsìš© ë°°ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(BG_BARS_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          bgBars[key] = parseInt(match[1], 10);
        }
      }
    } catch (e) {
      // ì»¤ìŠ¤í…€ ìƒ‰ìƒ íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
    }
  }

  // í›„ë°© í˜¸í™˜ì„±: bgëŠ” bgBadgesì˜ ë³„ì¹­
  return { fg, bg: bgBadges, bgBadges, bgBars, layout, iconType };
}

/**
 * ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì €ì¥
 * ì°¸ê³ : layout/iconTypeì€ í”„ë¦¬ë·° ì „ìš©ì´ë¯€ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŒ
 */
export function saveCustomColors(fg, bgBadges, bgBars) {
  // ë””ë ‰í† ë¦¬ ìƒì„±
  const dir = dirname(PATHS.customColor);
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true });
  }

  let content = `#!/bin/bash
# zstheme Custom Colors
# Generated by zstheme Color Editor
# Usage: Set CLAUDE_THEME="custom-<layout>[-nerd]" to use these colors
# Examples: custom-2line, custom-badges-nerd, custom-bars

`;

  // ì „ê²½ìƒ‰
  content += '# Foreground Colors\n';
  for (const [key, defaultVal] of Object.entries(FG_DEFAULTS)) {
    const code = fg[key] ?? defaultVal.code;
    content += `${key}=$'\\033[38;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  // badgesìš© ë°°ê²½ìƒ‰
  content += '\n# Background Colors (badges layout)\n';
  for (const [key, defaultVal] of Object.entries(BG_BADGES_DEFAULTS)) {
    const code = bgBadges[key] ?? defaultVal.code;
    content += `${key}=$'\\033[48;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  // barsìš© ë°°ê²½ìƒ‰
  content += '\n# Background Colors (bars layout)\n';
  for (const [key, defaultVal] of Object.entries(BG_BARS_DEFAULTS)) {
    const code = bgBars[key] ?? defaultVal.code;
    content += `${key}=$'\\033[48;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  writeFileSync(PATHS.customColor, content, { mode: 0o644 });

  return PATHS.customColor;
}

/**
 * ANSI 256 ìƒ‰ìƒ ì½”ë“œ â†’ hex ë³€í™˜
 */
export function ansi256ToHex(code) {
  // 0-7: í‘œì¤€ìƒ‰
  const STANDARD = [
    '#000000', '#800000', '#008000', '#808000',
    '#000080', '#800080', '#008080', '#c0c0c0',
  ];
  // 8-15: ë°ì€ìƒ‰
  const BRIGHT = [
    '#808080', '#ff0000', '#00ff00', '#ffff00',
    '#0000ff', '#ff00ff', '#00ffff', '#ffffff',
  ];

  if (code < 8) return STANDARD[code];
  if (code < 16) return BRIGHT[code - 8];

  // 16-231: 6x6x6 íë¸Œ
  if (code < 232) {
    const idx = code - 16;
    const r = Math.floor(idx / 36);
    const g = Math.floor((idx % 36) / 6);
    const b = idx % 6;
    const toVal = (v) => v === 0 ? 0 : 55 + v * 40;
    const hex = (v) => toVal(v).toString(16).padStart(2, '0');
    return `#${hex(r)}${hex(g)}${hex(b)}`;
  }

  // 232-255: ê·¸ë ˆì´ìŠ¤ì¼€ì¼
  const grey = 8 + (code - 232) * 10;
  const h = grey.toString(16).padStart(2, '0');
  return `#${h}${h}${h}`;
}

// Pastel FG: ë Œë”ëŸ¬ ì‹¤ì œ ìƒ‰ìƒ ê¸°ì¤€ (basic ANSI bright + ANSI 256)
const PASTEL_HEX = [
  '#ffff00',  // BRANCH: \033[93m bright yellow
  '#00ff00',  // TREE: \033[92m bright green
  '#00ffff',  // DIR: \033[96m bright cyan
  '#ff00ff',  // MODEL: \033[95m bright magenta
  '#87afff',  // STATUS: fg(111)
  '#af87ff',  // SYNC: fg(141)
  '#ffffaf',  // RATE: fg(229)
  '#ffaf87',  // BURN: fg(216)
  '#5fafff',  // TIME: fg(75)
];

function rgbToHex(r, g, b) {
  return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('');
}

function samplePalette(palette, count = 10) {
  const step = palette.length / count;
  return Array.from({ length: count }, (_, i) => {
    const [r, g, b] = palette[Math.floor(i * step)];
    return rgbToHex(r, g, b);
  });
}

/**
 * í…Œë§ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¡°íšŒ (hex ë°°ì—´)
 * ë Œë”ëŸ¬ì˜ ì‹¤ì œ ìƒ‰ìƒ ë¡œì§ê³¼ ì¼ì¹˜í•˜ë„ë¡ êµ¬í˜„
 */
export function getThemeColorPalette(themeName) {
  const { color, animation } = parseThemeContract(themeName);

  // ì• ë‹ˆë©”ì´ì…˜ í…Œë§ˆ: RGB íŒ”ë ˆíŠ¸ì—ì„œ ìƒ˜í”Œë§
  if (animation !== 'static') {
    let palette;
    if (color === 'mono') palette = MONO_CYCLE;
    else if (animation === 'lsd') palette = LSD_COLORS;
    else palette = RAINBOW_COLORS;
    return samplePalette(palette);
  }

  // static mono
  if (color === 'mono') {
    return [ansi256ToHex(250)];
  }

  // static custom (ANSI 256 codes)
  if (color === 'custom') {
    const { fg } = loadCustomColors();
    return Object.values(fg).map(ansi256ToHex);
  }

  // static pastel
  return PASTEL_HEX;
}

/**
 * ìƒ‰ìƒ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
 */
export function resetToDefaults() {
  const fg = {};
  const bgBadges = {};
  const bgBars = {};

  for (const [key, val] of Object.entries(FG_DEFAULTS)) {
    fg[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BADGES_DEFAULTS)) {
    bgBadges[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BARS_DEFAULTS)) {
    bgBars[key] = val.code;
  }

  // í›„ë°© í˜¸í™˜ì„±: bgëŠ” bgBadgesì˜ ë³„ì¹­
  return { fg, bg: bgBadges, bgBadges, bgBars, layout: '2line', iconType: 'nerd' };
}

import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { dirname } from 'path';
import { PATHS } from './config.js';

// ì „ê²½ìƒ‰ ê¸°ë³¸ê°’
export const FG_DEFAULTS = {
  C_BRANCH: { name: 'Branch', code: 93 },
  C_TREE: { name: 'Worktree', code: 92 },
  C_DIR: { name: 'Directory', code: 96 },
  C_MODEL: { name: 'Model', code: 95 },
  C_STATUS: { name: 'Status', code: 111 },
  C_SYNC: { name: 'Sync', code: 141 },
  C_RATE: { name: 'Rate', code: 229 },
  C_BURN: { name: 'Burn', code: 216 },
  C_TIME: { name: 'Time', code: 75 },
  C_CTX: { name: 'Context', code: 92 },
};

// badgesìš© ë°°ê²½ìƒ‰ ê¸°ë³¸ê°’ (ê°œë³„ ìš”ì†Œ)
export const BG_BADGES_DEFAULTS = {
  C_BG_BRANCH: { name: 'BG Branch', code: 58 },
  C_BG_TREE: { name: 'BG Worktree', code: 22 },
  C_BG_DIR: { name: 'BG Dir', code: 23 },
  C_BG_STATUS: { name: 'BG Status', code: 24 },
  C_BG_SYNC: { name: 'BG Sync', code: 53 },
  C_BG_MODEL: { name: 'BG Model', code: 53 },
  C_BG_RATE: { name: 'BG Rate', code: 58 },
  C_BG_TIME: { name: 'BG Time', code: 24 },
  C_BG_BURN: { name: 'BG Burn', code: 94 },
};

// barsìš© ë°°ê²½ìƒ‰ ê¸°ë³¸ê°’ (ê·¸ë£¹)
export const BG_BARS_DEFAULTS = {
  C_BG_LOC: { name: 'BG Location', code: 23 },
  C_BG_GIT: { name: 'BG Git', code: 24 },
  C_BG_SES: { name: 'BG Session', code: 53 },
};

// ì•„ì´ì½˜ ì •ì˜
export const ICONS = {
  emoji: {
    BRANCH: 'ğŸ”±',
    TREE: 'ğŸŒ¿',
    DIR: 'ğŸ“‚',
    STATUS: 'ğŸ’¾',
    SYNC: 'ğŸ”®',
    MODEL: 'ğŸ§ ',
    TIME: 'â³',
    SESSION: 'ğŸ’¬',
    COST: 'ğŸ’°',
    THEME: 'ğŸ¨',
    CTX: 'ğŸ”‹',
  },
  nerd: {
    BRANCH: 'ó°˜¬ ',
    TREE: 'ó°™… ',
    DIR: 'ó°° ',
    STATUS: 'ó°Š¤ ',
    SYNC: 'ó°“¦ ',
    MODEL: 'ó°š© ',
    TIME: 'ó°… ',
    SESSION: 'ó°­» ',
    COST: 'ó°†¼ ',
    THEME: 'ó°‰¼ ',
    CTX: 'ó°¹ ',
  }
};

// ë ˆì´ì•„ì›ƒ ëª©ë¡
export const LAYOUTS = ['1line', '2line', 'card', 'bars', 'badges'];

// ë°°ê²½ìƒ‰ì´ í•„ìš”í•œ ë ˆì´ì•„ì›ƒ
export const LAYOUTS_WITH_BG = ['bars', 'badges'];

// í›„ë°© í˜¸í™˜ì„±: BG_DEFAULTSëŠ” BG_BADGES_DEFAULTSì˜ ë³„ì¹­
export const BG_DEFAULTS = BG_BADGES_DEFAULTS;

/**
 * ì»¤ìŠ¤í…€ ìƒ‰ìƒ ë¡œë“œ
 * ì°¸ê³ : layout/iconTypeì€ í”„ë¦¬ë·° ì „ìš©ì´ë¯€ë¡œ í•­ìƒ ê¸°ë³¸ê°’(2line/nerd) ë°˜í™˜
 */
export function loadCustomColors() {
  const fg = {};
  const bgBadges = {};
  const bgBars = {};
  // í”„ë¦¬ë·°ìš© ê¸°ë³¸ê°’ (ì €ì¥ë˜ì§€ ì•ŠìŒ)
  const layout = '2line';
  const iconType = 'nerd';

  // ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
  for (const [key, val] of Object.entries(FG_DEFAULTS)) {
    fg[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BADGES_DEFAULTS)) {
    bgBadges[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BARS_DEFAULTS)) {
    bgBars[key] = val.code;
  }

  // ì»¤ìŠ¤í…€ íŒŒì¼ì´ ìˆìœ¼ë©´ ìƒ‰ìƒë§Œ ë¡œë“œ
  if (existsSync(PATHS.customColor)) {
    try {
      const content = readFileSync(PATHS.customColor, 'utf-8');

      // ì „ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(FG_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          fg[key] = parseInt(match[1], 10);
        }
      }

      // badgesìš© ë°°ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(BG_BADGES_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          bgBadges[key] = parseInt(match[1], 10);
        }
      }

      // barsìš© ë°°ê²½ìƒ‰ íŒŒì‹±
      for (const key of Object.keys(BG_BARS_DEFAULTS)) {
        const match = content.match(new RegExp(`${key}_CODE=(\\d+)`));
        if (match) {
          bgBars[key] = parseInt(match[1], 10);
        }
      }
    } catch {
      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
    }
  }

  // í›„ë°© í˜¸í™˜ì„±: bgëŠ” bgBadgesì˜ ë³„ì¹­
  return { fg, bg: bgBadges, bgBadges, bgBars, layout, iconType };
}

/**
 * ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì €ì¥
 * ì°¸ê³ : layout/iconTypeì€ í”„ë¦¬ë·° ì „ìš©ì´ë¯€ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŒ
 */
export function saveCustomColors(fg, bgBadges, bgBars) {
  // ë””ë ‰í† ë¦¬ ìƒì„±
  const dir = dirname(PATHS.customColor);
  if (!existsSync(dir)) {
    mkdirSync(dir, { recursive: true });
  }

  let content = `#!/bin/bash
# zstheme Custom Colors
# Generated by zstheme Color Editor
# Usage: Set CLAUDE_THEME="custom-<layout>[-nerd]" to use these colors
# Examples: custom-2line, custom-badges-nerd, custom-bars

`;

  // ì „ê²½ìƒ‰
  content += '# Foreground Colors\n';
  for (const [key, defaultVal] of Object.entries(FG_DEFAULTS)) {
    const code = fg[key] ?? defaultVal.code;
    content += `${key}=$'\\033[38;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  // badgesìš© ë°°ê²½ìƒ‰
  content += '\n# Background Colors (badges layout)\n';
  for (const [key, defaultVal] of Object.entries(BG_BADGES_DEFAULTS)) {
    const code = bgBadges[key] ?? defaultVal.code;
    content += `${key}=$'\\033[48;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  // barsìš© ë°°ê²½ìƒ‰
  content += '\n# Background Colors (bars layout)\n';
  for (const [key, defaultVal] of Object.entries(BG_BARS_DEFAULTS)) {
    const code = bgBars[key] ?? defaultVal.code;
    content += `${key}=$'\\033[48;5;${code}m'\n`;
    content += `${key}_CODE=${code}\n`;
  }

  writeFileSync(PATHS.customColor, content, { mode: 0o644 });

  return PATHS.customColor;
}

/**
 * ìƒ‰ìƒ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
 */
export function resetToDefaults() {
  const fg = {};
  const bgBadges = {};
  const bgBars = {};

  for (const [key, val] of Object.entries(FG_DEFAULTS)) {
    fg[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BADGES_DEFAULTS)) {
    bgBadges[key] = val.code;
  }
  for (const [key, val] of Object.entries(BG_BARS_DEFAULTS)) {
    bgBars[key] = val.code;
  }

  // í›„ë°© í˜¸í™˜ì„±: bgëŠ” bgBadgesì˜ ë³„ì¹­
  return { fg, bg: bgBadges, bgBadges, bgBars, layout: '2line', iconType: 'nerd' };
}

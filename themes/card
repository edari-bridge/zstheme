#!/bin/bash
# Card Theme - 2ì¤„ + ë°•ìŠ¤ ë“œë¡œì‰ + ë°°ê²½ìƒ‰

# ============================================================
# ìƒ‰ìƒ ì •ì˜
# ============================================================
RST=$'\033[0m'

# ë°•ìŠ¤/ë°°ê²½ ìƒ‰ìƒ
C_BOX=$'\033[38;5;240m'
C_BG=$'\033[48;5;235m'        # ì¹´ë“œ ë°°ê²½

# Git ìƒíƒœ ìƒ‰ìƒ
C_DIM_STATUS=$'\033[38;5;111m'
C_BRIGHT_STATUS=$'\033[1;38;5;153m'
C_DIM_SYNC=$'\033[38;5;141m'
C_BRIGHT_SYNC=$'\033[1;38;5;183m'

# Rate limit ìƒ‰ìƒ
C_RATE=$'\033[38;5;229m'
C_BURN=$'\033[38;5;216m'
C_TIME=$'\033[38;5;75m'

# ============================================================
# ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ ì„¤ì •
# ============================================================
set_context_colors() {
    if [[ "$CONTEXT_PCT" -ge 70 ]]; then
        C_BRANCH=$'\033[1;93m'
        C_TREE=$'\033[1;92m'
        C_DIR=$'\033[1;96m'
        C_MODEL=$'\033[1;95m'
        C_CTX=$'\033[1;91m'
        CTX_ICON="ğŸ”¥"
    elif [[ "$CONTEXT_PCT" -ge 50 ]]; then
        C_BRANCH=$'\033[1;33m'
        C_TREE=$'\033[1;32m'
        C_DIR=$'\033[1;36m'
        C_MODEL=$'\033[1;35m'
        C_CTX=$'\033[1;38;5;208m'
        CTX_ICON="ğŸª«"
    else
        C_BRANCH=$'\033[93m'
        C_TREE=$'\033[92m'
        C_DIR=$'\033[96m'
        C_MODEL=$'\033[95m'
        C_CTX=$'\033[0m'
        CTX_ICON="ğŸ”‹"
    fi
}

# ============================================================
# Git ìƒíƒœ í¬ë§·íŒ…
# ============================================================
format_git_status() {
    local add mod del
    [[ "$GIT_ADDED" -gt 0 ]] && add="${C_BRIGHT_STATUS}+${GIT_ADDED}${RST}${C_BG}" || add="${C_DIM_STATUS}+0${RST}${C_BG}"
    [[ "$GIT_MODIFIED" -gt 0 ]] && mod="${C_BRIGHT_STATUS}~${GIT_MODIFIED}${RST}${C_BG}" || mod="${C_DIM_STATUS}~0${RST}${C_BG}"
    [[ "$GIT_DELETED" -gt 0 ]] && del="${C_BRIGHT_STATUS}-${GIT_DELETED}${RST}${C_BG}" || del="${C_DIM_STATUS}-0${RST}${C_BG}"
    echo "ğŸ’¾ ${add}  ${mod}  ${del}"
}

format_git_sync() {
    local ahead behind
    [[ "$GIT_AHEAD" -gt 0 ]] && ahead="${C_BRIGHT_SYNC}â†‘ ${GIT_AHEAD}${RST}${C_BG}" || ahead="${C_DIM_SYNC}â†‘ 0${RST}${C_BG}"
    [[ "$GIT_BEHIND" -gt 0 ]] && behind="${C_BRIGHT_SYNC}â†“ ${GIT_BEHIND}${RST}${C_BG}" || behind="${C_DIM_SYNC}â†“ 0${RST}${C_BG}"
    echo "ğŸ”® ${ahead}  ${behind}"
}

# ============================================================
# ë Œë”ë§ í•¨ìˆ˜
# ============================================================
render() {
    set_context_colors

    # ë°•ìŠ¤ ë¬¸ì
    local TL="${C_BOX}â•­${RST}"
    local TR="${C_BOX}â•®${RST}"
    local BL="${C_BOX}â•°${RST}"
    local BR="${C_BOX}â•¯${RST}"
    local V="${C_BOX}â”‚${RST}"

    # Line 1 ë‚´ìš© ì¡°ë¦½
    local line1_content="${C_BG}"
    if [[ -n "$BRANCH" ]]; then
        line1_content="${line1_content}${C_BRANCH}ğŸ”± ${BRANCH}${RST}${C_BG}"
    else
        line1_content="${line1_content}${C_BRANCH}ğŸ”± branch${RST}${C_BG}"
    fi
    line1_content="${line1_content}    "
    if [[ -n "$WORKTREE" ]]; then
        line1_content="${line1_content}${C_TREE}ğŸŒ¿ ${WORKTREE}${RST}${C_BG}"
    else
        line1_content="${line1_content}${C_TREE}ğŸŒ¿ worktree${RST}${C_BG}"
    fi
    line1_content="${line1_content}    ${C_DIR}ğŸ“‚ ${DIR_NAME}${RST}${C_BG}    "
    if [[ "$IS_GIT_REPO" == "true" ]]; then
        line1_content="${line1_content}$(format_git_status)    $(format_git_sync)"
    else
        line1_content="${line1_content}${C_DIM_STATUS}ğŸ’¾ status${RST}${C_BG}    ${C_DIM_SYNC}ğŸ”® sync${RST}${C_BG}"
    fi
    line1_content="${line1_content}    ${C_CTX}${CTX_ICON} ${CONTEXT_PCT}%${RST}"

    # Line 2 ë‚´ìš© ì¡°ë¦½
    local line2_content="${C_BG}${C_MODEL}ğŸ§  ${MODEL}${RST}${C_BG}"

    # Rate limit
    if [[ -n "$RATE_TIME_LEFT" && -n "$RATE_RESET_TIME" && -n "$RATE_LIMIT_PCT" ]]; then
        local rate_color
        if [[ "$RATE_LIMIT_PCT" -ge 80 ]]; then
            rate_color=$'\033[1;91m'
        elif [[ "$RATE_LIMIT_PCT" -ge 50 ]]; then
            rate_color=$'\033[1;38;5;208m'
        else
            rate_color=$'\033[38;5;229m'
        fi
        line2_content="${line2_content}     ${C_RATE}â³ ${RATE_TIME_LEFT} Â· ${RATE_RESET_TIME} (${rate_color}${RATE_LIMIT_PCT}%${C_RATE})${RST}${C_BG}"
    fi

    # ì„¸ì…˜ ì‹œê°„
    line2_content="${line2_content}     ${C_TIME}ğŸ’¬ ${SESSION_DURATION_MIN}m${RST}${C_BG}"

    # ë²ˆë ˆì´íŠ¸
    [[ -n "$BURN_RATE" ]] && line2_content="${line2_content}     ${C_BURN}ğŸ’° ${BURN_RATE}${RST}${C_BG}"

    # í…Œë§ˆ
    line2_content="${line2_content}     ${C_RATE}ğŸ¨ ${THEME_NAME}${RST}"

    # ì¶œë ¥ (ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¹´ë“œ)
    echo "${TL}${C_BG} ${line1_content} ${RST}${TR}"
    echo "${BL}${C_BG} ${line2_content} ${RST}${BR}"
}

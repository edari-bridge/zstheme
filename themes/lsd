#!/bin/bash
# LSD Theme - 2ì¤„ + ë¹¤ì§ë¹¤ì§ ë ˆì¸ë³´ìš° ìƒ‰ìƒ

# ============================================================
# ìƒ‰ìƒ ì •ì˜ - ë ˆì¸ë³´ìš° íŒ”ë ˆíŠ¸
# ============================================================
RST=$'\033[0m'
RAINBOW_COLORS=(196 208 226 46 51 21 93 201 199 213)

# í˜„ì¬ ì‹œê°„ ê¸°ë°˜ ì˜¤í”„ì…‹ (ìƒ‰ìƒ ìˆœí™˜)
COLOR_OFFSET=$(($(date +%s) % ${#RAINBOW_COLORS[@]}))

# Rate limit ìƒ‰ìƒ
C_RATE=$'\033[38;5;229m'
C_BURN=$'\033[38;5;216m'
C_TIME=$'\033[38;5;75m'

# ============================================================
# ë ˆì¸ë³´ìš° ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
# ============================================================
get_rainbow_color() {
    local idx=$(( ($1 + COLOR_OFFSET) % ${#RAINBOW_COLORS[@]} ))
    echo "\033[1;38;5;${RAINBOW_COLORS[$idx]}m"
}

# ============================================================
# Git ìƒíƒœ í¬ë§·íŒ… (ë ˆì¸ë³´ìš°)
# ============================================================
format_git_status() {
    local c1=$(get_rainbow_color 3)
    local c2=$(get_rainbow_color 4)
    local c3=$(get_rainbow_color 5)

    local add mod del
    [[ "$GIT_ADDED" -gt 0 ]] && add="${c1}+${GIT_ADDED}${RST}" || add="${c1}+0${RST}"
    [[ "$GIT_MODIFIED" -gt 0 ]] && mod="${c2}~${GIT_MODIFIED}${RST}" || mod="${c2}~0${RST}"
    [[ "$GIT_DELETED" -gt 0 ]] && del="${c3}-${GIT_DELETED}${RST}" || del="${c3}-0${RST}"

    echo "ğŸ’¾ ${add}  ${mod}  ${del}"
}

format_git_sync() {
    local c1=$(get_rainbow_color 6)
    local c2=$(get_rainbow_color 7)

    local ahead behind
    [[ "$GIT_AHEAD" -gt 0 ]] && ahead="${c1}â†‘ ${GIT_AHEAD}${RST}" || ahead="${c1}â†‘ 0${RST}"
    [[ "$GIT_BEHIND" -gt 0 ]] && behind="${c2}â†“ ${GIT_BEHIND}${RST}" || behind="${c2}â†“ 0${RST}"

    echo "ğŸ”® ${ahead}  ${behind}"
}

# ============================================================
# ë Œë”ë§ í•¨ìˆ˜
# ============================================================
render() {
    # Line 1
    local line1_parts=()

    # ë¸Œëœì¹˜
    local c=$(get_rainbow_color 0)
    if [[ -n "$BRANCH" ]]; then
        line1_parts+=("${c}ğŸ”± ${BRANCH}${RST}")
    else
        line1_parts+=("${c}ğŸ”± branch${RST}")
    fi

    # ì›Œí¬íŠ¸ë¦¬
    c=$(get_rainbow_color 1)
    if [[ -n "$WORKTREE" ]]; then
        line1_parts+=("${c}ğŸŒ¿ ${WORKTREE}${RST}")
    else
        line1_parts+=("${c}ğŸŒ¿ worktree${RST}")
    fi

    # ë””ë ‰í† ë¦¬
    c=$(get_rainbow_color 2)
    line1_parts+=("${c}ğŸ“‚ ${DIR_NAME}${RST}")

    # Git ìƒíƒœ
    if [[ "$IS_GIT_REPO" == "true" ]]; then
        line1_parts+=("$(format_git_status)")
        line1_parts+=("$(format_git_sync)")
    else
        c=$(get_rainbow_color 3)
        line1_parts+=("${c}ğŸ’¾ status${RST}")
        c=$(get_rainbow_color 6)
        line1_parts+=("${c}ğŸ”® sync${RST}")
    fi

    # ì»¨í…ìŠ¤íŠ¸
    c=$(get_rainbow_color 8)
    if [[ "$CONTEXT_PCT" -ge 80 ]]; then
        line1_parts+=("${c}ğŸ”¥ ${CONTEXT_PCT}%${RST}")
    elif [[ "$CONTEXT_PCT" -ge 50 ]]; then
        line1_parts+=("${c}ğŸª« ${CONTEXT_PCT}%${RST}")
    else
        line1_parts+=("${c}ğŸ”‹ ${CONTEXT_PCT}%${RST}")
    fi

    # Line 2
    local line2_parts=()

    # ëª¨ë¸
    c=$(get_rainbow_color 9)
    line2_parts+=("${c}ğŸ§  ${MODEL}${RST}")

    # Rate limit
    if [[ -n "$RATE_TIME_LEFT" && -n "$RATE_RESET_TIME" && -n "$RATE_LIMIT_PCT" ]]; then
        local rate_color
        if [[ "$RATE_LIMIT_PCT" -ge 80 ]]; then
            rate_color=$'\033[1;91m'
        elif [[ "$RATE_LIMIT_PCT" -ge 50 ]]; then
            rate_color=$'\033[1;38;5;208m'
        else
            rate_color=$'\033[38;5;229m'
        fi
        line2_parts+=("${C_RATE}â³ ${RATE_TIME_LEFT} Â· ${RATE_RESET_TIME} (${rate_color}${RATE_LIMIT_PCT}%${C_RATE})${RST}")
    fi

    # ë²ˆë ˆì´íŠ¸
    [[ -n "$BURN_RATE" ]] && line2_parts+=("${C_BURN}ğŸ’° ${BURN_RATE}${RST}")

    # ì„¸ì…˜ ì‹œê°„
    line2_parts+=("${C_TIME}ğŸ’¬ ${SESSION_DURATION_MIN}m${RST}")

    # í…Œë§ˆ
    c=$(get_rainbow_color 0)
    line2_parts+=("${c}ğŸ¨ ${THEME_NAME}${RST}")

    # ì¶œë ¥
    local line1="" line2=""
    for i in "${!line1_parts[@]}"; do
        [[ $i -eq 0 ]] && line1="${line1_parts[$i]}" || line1="$line1    ${line1_parts[$i]}"
    done
    for i in "${!line2_parts[@]}"; do
        [[ $i -eq 0 ]] && line2="${line2_parts[$i]}" || line2="$line2     ${line2_parts[$i]}"
    done

    echo -e "$line1"
    echo -e "$line2"
}

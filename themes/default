#!/bin/bash
# Card Theme - ë°•ìŠ¤ ë‘ ì¥ + ë°°í„°ë¦¬ ì‹œê°í™”

# ============================================================
# ìƒ‰ìƒ ì •ì˜
# ============================================================
RST=$'\033[0m'
C_BOX=$'\033[38;5;240m'
C_BRANCH=$'\033[93m'
C_TREE=$'\033[92m'
C_DIR=$'\033[96m'
C_MODEL=$'\033[95m'
C_RATE=$'\033[38;5;229m'
C_BURN=$'\033[38;5;216m'
C_TIME=$'\033[38;5;75m'
C_DIM_STATUS=$'\033[38;5;111m'
C_BRIGHT_STATUS=$'\033[1;38;5;153m'
C_DIM_SYNC=$'\033[38;5;141m'
C_BRIGHT_SYNC=$'\033[1;38;5;183m'

# ë°°í„°ë¦¬ ë°°ê²½ìƒ‰ (ì˜…ì§€ë§Œ êµ¬ë¶„ ê°€ëŠ¥)
C_BAT_EMPTY=$'\033[48;5;236m'     # ë¹ˆ ë¶€ë¶„ ë°°ê²½ (ì–´ë‘ìš´ íšŒìƒ‰)
C_BAT_GREEN=$'\033[48;5;23m'      # ì˜…ì€ ì´ˆë¡ (0-50%)
C_BAT_YELLOW=$'\033[48;5;94m'     # ì˜…ì€ ì£¼í™© (50-80%)
C_BAT_RED=$'\033[48;5;52m'        # ì˜…ì€ ë¹¨ê°• (80%+)

# ì»¨í…ìŠ¤íŠ¸ ê¸€ì ìƒ‰ìƒ (2-line ìŠ¤íƒ€ì¼)
C_CTX_NORMAL=$'\033[0m'           # ê¸°ë³¸
C_CTX_WARN=$'\033[1;38;5;208m'    # ì£¼í™© (50-80%)
C_CTX_CRIT=$'\033[1;91m'          # ë¹¨ê°• (80%+)

# ============================================================
# ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ (ë‚¨ì€ ë°°í„°ë¦¬ ê¸°ì¤€)
# ============================================================
set_context_colors() {
    if [[ "$CONTEXT_PCT" -ge 70 ]]; then
        C_BAT_FILL="$C_BAT_RED"
        C_CTX_TEXT="$C_CTX_CRIT"
    elif [[ "$CONTEXT_PCT" -ge 50 ]]; then
        C_BAT_FILL="$C_BAT_YELLOW"
        C_CTX_TEXT="$C_CTX_WARN"
    else
        C_BAT_FILL="$C_BAT_GREEN"
        C_CTX_TEXT="$C_CTX_NORMAL"
    fi
}

# ============================================================
# íŒ¨ë”© í•¨ìˆ˜
# ============================================================
pad_to() {
    local text="$1"
    local target_width="$2"
    local plain=$(echo -e "$text" | sed 's/\x1b\[[0-9;]*m//g')
    local emoji_count=$(echo "$plain" | grep -o '[ğŸ”±ğŸŒ¿ğŸ“‚ğŸ’¾ğŸ”®ğŸ”‹ğŸ”¥ğŸª«ğŸ§ â³ğŸ’°ğŸ’¬ğŸ¨]' | wc -l | tr -d ' ')
    local char_count=${#plain}
    local actual_width=$((char_count + emoji_count))
    local pad=$((target_width - actual_width))
    [[ $pad -lt 0 ]] && pad=0
    printf "%s%*s" "$text" "$pad" ""
}

# ============================================================
# ë°°í„°ë¦¬ ì¤„ ìƒì„± (ë‚¨ì€ ë°°í„°ë¦¬ = 100 - ì»¨í…ìŠ¤íŠ¸%)
# ============================================================
battery_line() {
    local row="$1"
    local pct="$CONTEXT_PCT"
    local remaining=$((100 - pct))  # ë‚¨ì€ ë°°í„°ë¦¬

    # 4ì¤„ ì±„ì›€ (row 1,2,4,5), ì•„ë˜ì—ì„œë¶€í„° ì±„ì›Œì§
    # row 5 (ë§¨ì•„ë˜): remaining > 0
    # row 4: remaining > 25
    # row 2: remaining > 50
    # row 1 (ë§¨ìœ„): remaining > 75

    if [[ $row -eq 3 ]]; then
        # ì¤‘ê°„ ì¤„: í¼ì„¼íŠ¸ ìˆ«ì (ê°€ìš´ë° ì •ë ¬)
        local str=$(printf "%d%%" "$pct")
        local len=${#str}
        local left=$(( (5 - len) / 2 ))
        local right=$(( 5 - len - left ))
        printf "%*s${C_CTX_TEXT}%s${RST}%*s" "$left" "" "$str" "$right" ""
    else
        # ì•„ë˜ì—ì„œë¶€í„° ì±„ì›€
        local threshold
        case $row in
            1) threshold=75 ;;
            2) threshold=50 ;;
            4) threshold=25 ;;
            5) threshold=0 ;;
        esac

        if [[ $remaining -gt $threshold ]]; then
            printf "${C_BAT_FILL}     ${RST}"
        else
            printf "${C_BAT_EMPTY}     ${RST}"
        fi
    fi
}

# ============================================================
# ë Œë”ë§ í•¨ìˆ˜
# ============================================================
render() {
    set_context_colors

    local V="${C_BOX}â”‚${RST}"
    local W=20  # ì¹´ë“œ ë‚´ë¶€ ë„ˆë¹„

    # Git ìƒíƒœ í¬ë§·íŒ…
    local add mod del
    [[ "$GIT_ADDED" -gt 0 ]] && add="${C_BRIGHT_STATUS}+${GIT_ADDED}${RST}" || add="${C_DIM_STATUS}+0${RST}"
    [[ "$GIT_MODIFIED" -gt 0 ]] && mod="${C_BRIGHT_STATUS}~${GIT_MODIFIED}${RST}" || mod="${C_DIM_STATUS}~0${RST}"
    [[ "$GIT_DELETED" -gt 0 ]] && del="${C_BRIGHT_STATUS}-${GIT_DELETED}${RST}" || del="${C_DIM_STATUS}-0${RST}"

    # Push/Pull í¬ë§·íŒ…
    local ahead behind
    [[ "$GIT_AHEAD" -gt 0 ]] && ahead="${C_BRIGHT_SYNC}â†‘ ${GIT_AHEAD}${RST}" || ahead="${C_DIM_SYNC}â†‘ 0${RST}"
    [[ "$GIT_BEHIND" -gt 0 ]] && behind="${C_BRIGHT_SYNC}â†“ ${GIT_BEHIND}${RST}" || behind="${C_DIM_SYNC}â†“ 0${RST}"

    # ì™¼ìª½ ì¹´ë“œ ë‚´ìš©
    local L1="${C_BRANCH}ğŸ”± ${BRANCH:-branch}${RST}"
    local L2="${C_TREE}ğŸŒ¿ ${WORKTREE:-worktree}${RST}"
    local L3="${C_DIR}ğŸ“‚ ${DIR_NAME}${RST}"
    local L4="ğŸ’¾ ${add}  ${mod}  ${del}"
    local L5="ğŸ”® ${ahead}  ${behind}"

    # ì˜¤ë¥¸ìª½ ì¹´ë“œ ë‚´ìš©
    local R1="${C_MODEL}ğŸ§  ${MODEL}${RST}"
    local R2="${C_RATE}â³ ${RATE_TIME_LEFT:-0m} Â· ${RATE_RESET_TIME:-00:00}${RST}"
    local R3="${C_TIME}ğŸ’¬ ${SESSION_DURATION_MIN}m${RST}"
    local R4="${C_BURN}ğŸ’° ${BURN_RATE:-\$0/h}${RST}"
    local R5="${C_RATE}ğŸ¨ ${THEME_NAME}${RST}"

    # í…Œë‘ë¦¬
    local TOP1="${C_BOX}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RST}"
    local BOT1="${C_BOX}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RST}"
    local BTOP="${C_BOX}â•­â”€â”€â”€â”€â”€â•®${RST}"
    local BBOT="${C_BOX}â•°â”€â”€â”€â”€â”€â•¯${RST}"
    local BV="${C_BOX}â”‚${RST}"

    # ì¶œë ¥
    echo "${TOP1}  ${TOP1}  ${BTOP}"
    echo "${V} $(pad_to "$L1" $W) ${V}  ${V} $(pad_to "$R1" $W) ${V}  ${BV}$(battery_line 1)${BV}"
    echo "${V} $(pad_to "$L2" $W) ${V}  ${V} $(pad_to "$R2" $W) ${V}  ${BV}$(battery_line 2)${BV}"
    echo "${V} $(pad_to "$L3" $W) ${V}  ${V} $(pad_to "$R3" $W) ${V}  ${BV}$(battery_line 3)${BV}"
    echo "${V} $(pad_to "$L4" $W) ${V}  ${V} $(pad_to "$R4" $W) ${V}  ${BV}$(battery_line 4)${BV}"
    echo "${V} $(pad_to "$L5" $W) ${V}  ${V} $(pad_to "$R5" $W) ${V}  ${BV}$(battery_line 5)${BV}"
    echo "${BOT1}  ${BOT1}  ${BBOT}"
}

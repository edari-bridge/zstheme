#!/bin/bash
# Default-2line Theme - í˜„ì¬ ìŠ¤íƒ€ì¼ + rate limit (2ì¤„)
# Line 1: ğŸ”± main  ğŸŒ¿ notes  ğŸ“‚ bridge  ğŸ’¾ +2 ~1 -0  ğŸ”® â†‘1 â†“0
# Line 2: ğŸ§  Opus 4.5  ğŸ”‹ 45%  â³ 2h 30m until 04:00 (58%)  ğŸ’° $4.76/h  â±ï¸ 25m

# ============================================================
# ìƒ‰ìƒ ì •ì˜
# ============================================================
RST=$'\033[0m'

# Git ìƒíƒœ ìƒ‰ìƒ
C_DIM_STATUS=$'\033[38;5;111m'
C_BRIGHT_STATUS=$'\033[1;38;5;153m'

# Push/Pull ìƒ‰ìƒ
C_DIM_SYNC=$'\033[38;5;141m'
C_BRIGHT_SYNC=$'\033[1;38;5;183m'

# Rate limit ìƒ‰ìƒ
C_RATE=$'\033[38;5;229m'          # ì—°í•œ ë…¸ë‘
C_BURN=$'\033[38;5;216m'          # ì—°í•œ ì£¼í™©
C_TIME=$'\033[38;5;75m'           # ì—°í•œ íŒŒë‘ (ğŸ’¬ê³¼ ìœ ì‚¬)

# ============================================================
# ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒ‰ìƒ ì„¤ì •
# ============================================================
set_context_colors() {
    if [[ "$CONTEXT_PCT" -ge 80 ]]; then
        C_BRANCH=$'\033[1;93m'
        C_TREE=$'\033[1;92m'
        C_SAVE=$'\033[1;94m'
        C_SYNC=$'\033[1;95m'
        C_DIR=$'\033[1;96m'
        C_MODEL=$'\033[1;95m'
        C_CTX=$'\033[1;91m'
        CTX_ICON="ğŸ”¥"
    elif [[ "$CONTEXT_PCT" -ge 50 ]]; then
        C_BRANCH=$'\033[1;33m'
        C_TREE=$'\033[1;32m'
        C_SAVE=$'\033[1;34m'
        C_SYNC=$'\033[1;35m'
        C_DIR=$'\033[1;36m'
        C_MODEL=$'\033[1;35m'
        C_CTX=$'\033[1;38;5;208m'
        CTX_ICON="ğŸª«"
    else
        C_BRANCH=$'\033[93m'
        C_TREE=$'\033[92m'
        C_SAVE=$'\033[94m'
        C_SYNC=$'\033[95m'
        C_DIR=$'\033[96m'
        C_MODEL=$'\033[95m'
        C_CTX=$'\033[0m'
        CTX_ICON="ğŸ”‹"
    fi
}

# ============================================================
# Git ìƒíƒœ í¬ë§·íŒ…
# ============================================================
format_git_status() {
    local add_part mod_part del_part

    if [[ "$GIT_ADDED" -gt 0 ]]; then
        add_part="${C_BRIGHT_STATUS}+${GIT_ADDED}${RST}"
    else
        add_part="${C_DIM_STATUS}+0${RST}"
    fi

    if [[ "$GIT_MODIFIED" -gt 0 ]]; then
        mod_part="${C_BRIGHT_STATUS}~${GIT_MODIFIED}${RST}"
    else
        mod_part="${C_DIM_STATUS}~0${RST}"
    fi

    if [[ "$GIT_DELETED" -gt 0 ]]; then
        del_part="${C_BRIGHT_STATUS}-${GIT_DELETED}${RST}"
    else
        del_part="${C_DIM_STATUS}-0${RST}"
    fi

    echo "ğŸ’¾ ${add_part}  ${mod_part}  ${del_part}"
}

format_git_sync() {
    local ahead_part behind_part

    if [[ "$GIT_AHEAD" -gt 0 ]]; then
        ahead_part="${C_BRIGHT_SYNC}â†‘ ${GIT_AHEAD}${RST}"
    else
        ahead_part="${C_DIM_SYNC}â†‘ 0${RST}"
    fi

    if [[ "$GIT_BEHIND" -gt 0 ]]; then
        behind_part="${C_BRIGHT_SYNC}â†“ ${GIT_BEHIND}${RST}"
    else
        behind_part="${C_DIM_SYNC}â†“ 0${RST}"
    fi

    echo "ğŸ”® ${ahead_part}  ${behind_part}"
}

# ============================================================
# ë Œë”ë§ í•¨ìˆ˜
# ============================================================
render() {
    set_context_colors

    # Line 1: Git ì •ë³´ + ì»¨í…ìŠ¤íŠ¸ (ìš°ì¸¡ ë)
    local line1_parts=()
    if [[ -n "$BRANCH" ]]; then
        line1_parts+=("${C_BRANCH}ğŸ”± ${BRANCH}${RST}")
    else
        line1_parts+=("${C_BRANCH}ğŸ”± branch${RST}")
    fi
    if [[ -n "$WORKTREE" ]]; then
        line1_parts+=("${C_TREE}ğŸŒ¿ ${WORKTREE}${RST}")
    else
        line1_parts+=("${C_TREE}ğŸŒ¿ worktree${RST}")
    fi
    line1_parts+=("${C_DIR}ğŸ“‚ ${DIR_NAME}${RST}")
    if [[ "$IS_GIT_REPO" == "true" ]]; then
        line1_parts+=("$(format_git_status)")
        line1_parts+=("$(format_git_sync)")
    else
        line1_parts+=("${C_DIM_STATUS}ğŸ’¾ status${RST}")
        line1_parts+=("${C_DIM_SYNC}ğŸ”® sync${RST}")
    fi
    line1_parts+=("${C_CTX}${CTX_ICON} ${CONTEXT_PCT}%${RST}")

    # Line 2: ì„¸ì…˜ ì •ë³´ + í…Œë§ˆ (ìš°ì¸¡ ë)
    local line2_parts=()
    line2_parts+=("${C_MODEL}ğŸ§  ${MODEL}${RST}")

    # Rate limit ì •ë³´ (í¼ì„¼íŠ¸ì— ë”°ë¥¸ ë™ì  ìƒ‰ìƒ)
    if [[ -n "$RATE_TIME_LEFT" && -n "$RATE_RESET_TIME" && -n "$RATE_LIMIT_PCT" ]]; then
        local rate_color
        if [[ "$RATE_LIMIT_PCT" -ge 80 ]]; then
            rate_color=$'\033[1;91m'  # ë¹¨ê°• (ìœ„í—˜)
        elif [[ "$RATE_LIMIT_PCT" -ge 50 ]]; then
            rate_color=$'\033[1;38;5;208m'  # ì£¼í™© (ê²½ê³ )
        else
            rate_color=$'\033[38;5;229m'  # ê¸°ë³¸ ì—°í•œ ë…¸ë‘
        fi
        line2_parts+=("${C_RATE}â³ ${RATE_TIME_LEFT} Â· ${RATE_RESET_TIME} (${rate_color}${RATE_LIMIT_PCT}%${C_RATE})${RST}")
    elif [[ -n "$RATE_LIMIT_PCT" ]]; then
        line2_parts+=("${C_RATE}â³ ${RATE_LIMIT_PCT}%${RST}")
    fi

    # ë²ˆë ˆì´íŠ¸
    [[ -n "$BURN_RATE" ]] && line2_parts+=("${C_BURN}ğŸ’° ${BURN_RATE}${RST}")

    # ì„¸ì…˜ ì‹œê°„
    line2_parts+=("${C_TIME}ğŸ’¬ ${SESSION_DURATION_MIN}m${RST}")

    # í˜„ì¬ í…Œë§ˆ (ìš°ì¸¡ ë)
    line2_parts+=("${C_RATE}ğŸ¨ ${THEME_NAME}${RST}")

    # ì¶œë ¥
    local line1="" line2=""
    for i in "${!line1_parts[@]}"; do
        [[ $i -eq 0 ]] && line1="${line1_parts[$i]}" || line1="$line1    ${line1_parts[$i]}"
    done
    for i in "${!line2_parts[@]}"; do
        [[ $i -eq 0 ]] && line2="${line2_parts[$i]}" || line2="$line2     ${line2_parts[$i]}"
    done

    echo "$line1"
    echo "$line2"
}

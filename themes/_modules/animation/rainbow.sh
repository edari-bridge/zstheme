#!/bin/bash
# Rainbow Animation Module - 요소 단위 빠른 색상 순환
# 시간 기반 색상 오프셋으로 사이키델릭 효과 (0.1초 단위)

# ============================================================
# 레인보우 팔레트
# ============================================================

# 컬러 레인보우
# 컬러 레인보우 (Pastel Sine Wave: Base 200, Amplitude 55 - Matches zstheme Logo)
RAINBOW_COLORS=("200;250;158" "205;253;150" "210;254;142" "216;254;135" "221;253;128" "226;251;122" "231;248;116" "236;244;111" "240;239;107" "244;233;104" "248;226;101" "250;219;100" "253;211;100" "254;203;100" "254;194;102" "255;185;105" "254;177;109" "253;168;113" "251;159;119" "248;152;125" "245;144;133" "241;137;141" "237;131;149" "232;126;158" "227;122;167" "221;119;177" "215;117;187" "209;116;196" "203;116;205" "196;118;214" "189;121;222" "183;125;229" "176;130;236" "170;136;242" "164;143;247" "159;151;251" "154;159;253" "150;168;254" "147;177;254" "145;187;252" "145;196;250" "145;206;246" "147;215;241" "150;223;235" "155;231;228" "160;239;220" "167;245;211" "174;250;202" "182;253;193" "190;255;184" "199;255;176" "208;254;168" "217;252;161" "225;249;155" "233;244;150" "240;239;147" "246;233;145" "251;225;144" "254;217;145" "255;209;148")

# 모노 레인보우 (회색 순환)
# 모노 레인보우 (Smooth Grayscale: Base 192, Amplitude 63)
MONO_CYCLE=("192;192;192" "198;198;198" "204;204;204" "210;210;210" "216;216;216" "222;222;222" "227;227;227" "232;232;232" "237;237;237" "241;241;241" "245;245;245" "248;248;248" "250;250;250" "252;252;252" "254;254;254" "254;254;254" "254;254;254" "254;254;254" "253;253;253" "251;251;251" "249;249;249" "246;246;246" "242;242;242" "238;238;238" "234;234;234" "229;229;229" "224;224;224" "218;218;218" "213;213;213" "207;207;207" "200;200;200" "194;194;194" "188;188;188" "182;182;182" "175;175;175" "169;169;169" "164;164;164" "158;158;158" "153;153;153" "148;148;148" "144;144;144" "140;140;140" "137;137;137" "134;134;134" "132;132;132" "130;130;130" "129;129;129" "129;129;129" "129;129;129" "130;130;130" "131;131;131" "133;133;133" "136;136;136" "139;139;139" "143;143;143" "147;147;147" "152;152;152" "157;157;157" "162;162;162" "168;168;168")

# 시간 기반 오프셋 (0.1초 단위 - 빠른 변화)
COLOR_OFFSET=$(($(date +%s%N | cut -c1-10) % 60))

# 배경색 오프셋 (bars용 - 3가지 순환)
BG_OFFSET=$(($(date +%s%N | cut -c1-10) % 3))

# ============================================================
# 색상 순환 함수
# ============================================================

get_animated_color() {
    local idx="$1"
    local actual_idx=$(( (idx + COLOR_OFFSET) % 60 ))

    if [[ "$COLOR_MODE" == "mono" ]]; then
        echo "\033[1;38;2;${MONO_CYCLE[$actual_idx]}m"
    else
        echo "\033[1;38;2;${RAINBOW_COLORS[$actual_idx]}m"
    fi
}

# 배경색 순환 (bars 레이아웃용)
get_animated_bg() {
    local chip_idx="$1"  # 0=loc, 1=git, 2=ses
    local actual_idx=$(( (chip_idx + BG_OFFSET) % 3 ))

    # 배경색도 순환
    local bgs=("$C_BG_LOC" "$C_BG_GIT" "$C_BG_SES")
    echo "${bgs[$actual_idx]}"
}

# 배터리 색상 순환 (card 레이아웃용)
get_animated_battery_color() {
    if [[ "$COLOR_MODE" == "mono" ]]; then
        local idx=$(( ($(date +%s%N | cut -c1-10) % 8) ))
        echo "\033[48;5;$((236 + idx))m"
    else
        local idx=$(( ($(date +%s%N | cut -c1-10) % 60) ))
        echo "\033[48;2;${RAINBOW_COLORS[$idx]}m"
    fi
}

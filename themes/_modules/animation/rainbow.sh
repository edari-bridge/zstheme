#!/bin/bash
# Rainbow Animation Module - 요소 단위 빠른 색상 순환
# 시간 기반 색상 오프셋으로 사이키델릭 효과 (0.1초 단위)

# ============================================================
# 레인보우 팔레트
# ============================================================

# 컬러 레인보우
# 컬러 레인보우 (Vivid Gradient: Base 128, Amplitude 127)
RAINBOW_COLORS=("128;243;31" "140;237;24" "153;230;17" "165;222;11" "177;213;7" "188;204;3" "199;193;1" "209;182;1" "219;170;1" "227;158;3" "234;145;6" "241;133;10" "246;120;15" "250;107;22" "253;95;29" "254;83;38" "254;71;47" "253;60;58" "251;50;68" "248;40;80" "243;31;92" "237;24;104" "230;17;117" "222;11;130" "213;7;142" "204;3;155" "193;1;167" "182;1;179" "170;1;190" "158;3;201" "145;6;211" "133;10;220" "120;15;228" "107;22;236" "95;29;242" "83;38;247" "71;47;250" "60;58;253" "50;68;254" "40;80;254" "31;92;253" "24;104;251" "17;117;247" "11;130;242" "7;142;236" "3;155;229" "1;167;221" "1;179;212" "1;190;202" "3;201;191" "6;211;180" "10;220;168" "15;228;156" "22;236;143" "29;242;131" "38;247;118" "47;250;105" "58;253;93" "68;254;81" "80;254;69")

# 모노 레인보우 (회색 순환)
MONO_CYCLE=(255 252 250 248 246 244 242 240 238 236)

# 시간 기반 오프셋 (0.1초 단위 - 빠른 변화)
COLOR_OFFSET=$(($(date +%s%N | cut -c1-10) % 60))

# 배경색 오프셋 (bars용 - 3가지 순환)
BG_OFFSET=$(($(date +%s%N | cut -c1-10) % 3))

# ============================================================
# 색상 순환 함수
# ============================================================

get_animated_color() {
    local idx="$1"
    local actual_idx=$(( (idx + COLOR_OFFSET) % 60 ))

    if [[ "$COLOR_MODE" == "mono" ]]; then
        local mono_idx=$(( actual_idx % 10 ))
        echo "\033[1;38;5;${MONO_CYCLE[$mono_idx]}m"
    else
        echo "\033[1;38;2;${RAINBOW_COLORS[$actual_idx]}m"
    fi
}

# 배경색 순환 (bars 레이아웃용)
get_animated_bg() {
    local chip_idx="$1"  # 0=loc, 1=git, 2=ses
    local actual_idx=$(( (chip_idx + BG_OFFSET) % 3 ))

    # 배경색도 순환
    local bgs=("$C_BG_LOC" "$C_BG_GIT" "$C_BG_SES")
    echo "${bgs[$actual_idx]}"
}

# 배터리 색상 순환 (card 레이아웃용)
get_animated_battery_color() {
    if [[ "$COLOR_MODE" == "mono" ]]; then
        local idx=$(( ($(date +%s%N | cut -c1-10) % 8) ))
        echo "\033[48;5;$((236 + idx))m"
    else
        local idx=$(( ($(date +%s%N | cut -c1-10) % 60) ))
        echo "\033[48;2;${RAINBOW_COLORS[$idx]}m"
    fi
}

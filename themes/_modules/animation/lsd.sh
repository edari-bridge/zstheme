#!/bin/bash
# LSD Animation Module - 글자 단위 빠른 색상 순환
# 각 문자에 다른 색상을 적용하여 그라데이션 효과 (0.1초 단위)

# ============================================================
# 레인보우 팔레트
# ============================================================

# 파스텔 레인보우 (기존 테마 톤앤무드 유지)
# LSD 팔레트 (Vivid Neon: High Saturation, High Contrast)
LSD_COLORS=("128;235;43" "140;229;30" "153;221;19" "165;213;10" "177;203;4" "189;192;1" "199;181;1" "209;168;3" "219;155;8" "227;142;15" "235;128;25" "241;115;37" "246;101;50" "250;89;66" "253;77;83" "254;66;100" "254;56;119" "253;48;137" "251;41;155" "248;35;173" "243;32;190" "237;31;206" "230;32;220" "222;35;232" "213;40;242" "204;47;250" "193;56;254" "182;66;254" "170;77;253" "159;89;250" "146;101;245" "134;114;239" "121;127;230" "108;141;220" "96;155;208" "84;167;194" "72;180;179" "61;191;163" "51;202;146" "42;212;129" "33;221;112" "26;229;95" "20;235;78" "15;241;63" "12;245;48" "10;248;35" "9;250;23" "10;251;13" "12;252;6" "15;251;1" "19;250;0" "23;247;2" "29;243;6" "35;239;13" "43;234;22" "50;228;33" "59;222;46" "68;215;60" "78;207;76" "89;199;93")

# 모노 레인보우 (회색 순환)
# 모노 레인보우 (Smooth Grayscale: Base 192, Amplitude 63)
MONO_CYCLE=("192;192;192" "198;198;198" "204;204;204" "210;210;210" "216;216;216" "222;222;222" "227;227;227" "232;232;232" "237;237;237" "241;241;241" "245;245;245" "248;248;248" "250;250;250" "252;252;252" "254;254;254" "254;254;254" "254;254;254" "254;254;254" "253;253;253" "251;251;251" "249;249;249" "246;246;246" "242;242;242" "238;238;238" "234;234;234" "229;229;229" "224;224;224" "218;218;218" "213;213;213" "207;207;207" "200;200;200" "194;194;194" "188;188;188" "182;182;182" "175;175;175" "169;169;169" "164;164;164" "158;158;158" "153;153;153" "148;148;148" "144;144;144" "140;140;140" "137;137;137" "134;134;134" "132;132;132" "130;130;130" "129;129;129" "129;129;129" "129;129;129" "130;130;130" "131;131;131" "133;133;133" "136;136;136" "139;139;139" "143;143;143" "147;147;147" "152;152;152" "157;157;157" "162;162;162" "168;168;168")

# Chaotic Offset (Fast & Random)
# Multiplying by prime to create pseudo-random jumps while still cycling
# 0.1s check -> large jumps
COLOR_OFFSET=$(($(date +%s%N | cut -c1-10) * 17 % 60))

# 배경색 오프셋 (bars용 - 3가지 순환 + Chaotic)
BG_OFFSET=$(($(date +%s%N | cut -c1-10) * 7 % 3))

# ============================================================
# 글자 단위 색상화 함수 (LSD 핵심 기능)
# ============================================================

# 문자열을 글자 단위로 색상 적용 (UTF-8/이모지 지원)
colorize_text() {
    local text="$1"
    local start_idx="${2:-0}"
    local result=""
    local i=0

    # UTF-8 문자를 하나씩 처리 (grep -o로 문자 분리)
    while IFS= read -r char; do
        # Stride 7 for higher spatial frequency (more color changes per char)
        local color_idx=$(( (start_idx + (i * 7) + COLOR_OFFSET) % 60 ))

        if [[ "$COLOR_MODE" == "mono" ]]; then
            result+="\033[1;38;2;${MONO_CYCLE[$color_idx]}m${char}"
        else
            result+="\033[1;38;2;${LSD_COLORS[$color_idx]}m${char}"
        fi
        ((i++))
    done < <(echo -n "$text" | grep -oE '.' 2>/dev/null || echo -n "$text" | fold -w1)

    echo -e "${result}\033[0m"
}

# ============================================================
# 색상 순환 함수 (rainbow와 호환 - fallback용)
# ============================================================

get_animated_color() {
    local idx="$1"
    local actual_idx=$(( (idx + COLOR_OFFSET) % 60 ))

    if [[ "$COLOR_MODE" == "mono" ]]; then
        echo "\033[1;38;2;${MONO_CYCLE[$actual_idx]}m"
    else
        echo "\033[1;38;2;${RAINBOW_COLORS[$actual_idx]}m"
    fi
}

# 배경색 순환 (bars 레이아웃용)
get_animated_bg() {
    local chip_idx="$1"  # 0=loc, 1=git, 2=ses
    local actual_idx=$(( (chip_idx + BG_OFFSET) % 3 ))

    # 배경색도 순환
    local bgs=("$C_BG_LOC" "$C_BG_GIT" "$C_BG_SES")
    echo "${bgs[$actual_idx]}"
}

# 배경색 순환 (badges 레이아웃용 - 개별 요소)
# 6개 배경색 순환: branch, tree, dir, status, sync, model
get_animated_badge_bg() {
    local element_idx="$1"
    local actual_idx=$(( (element_idx + BG_OFFSET) % 6 ))

    local bgs=("$C_BG_BRANCH" "$C_BG_TREE" "$C_BG_DIR" "$C_BG_STATUS" "$C_BG_SYNC" "$C_BG_MODEL")
    echo "${bgs[$actual_idx]}"
}

# 배터리 색상 순환 (card 레이아웃용)
get_animated_battery_color() {
    if [[ "$COLOR_MODE" == "mono" ]]; then
        local idx=$(( ($(date +%s%N | cut -c1-10) % 8) ))
        echo "\033[48;5;$((236 + idx))m"
    else
        local idx=$(( ($(date +%s%N | cut -c1-10) % 10) ))
        echo "\033[48;5;${RAINBOW_COLORS[$idx]}m"
    fi
}

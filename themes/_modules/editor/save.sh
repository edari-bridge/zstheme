#!/bin/bash
# zstheme Color Editor - ì €ìž¥/ë¡œë“œ ê¸°ëŠ¥

# ============================================================
# ì„¤ì • ë””ë ‰í† ë¦¬
# ============================================================

CONFIG_DIR="$HOME/.config/zstheme"
CUSTOM_COLOR_FILE="$CONFIG_DIR/custom-color.sh"

# ============================================================
# ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì €ìž¥
# ============================================================

save_custom_colors() {
    # ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$CONFIG_DIR"

    # íŒŒì¼ ìƒì„±
    cat > "$CUSTOM_COLOR_FILE" << 'HEADER'
#!/bin/bash
# zstheme Custom Color Module - ì‚¬ìš©ìž ì»¤ìŠ¤í…€ ìƒ‰ìƒ
# Generated by zstheme --edit
# Do not edit manually unless you know what you're doing

# ============================================================
# ìƒ‰ìƒ ì½”ë“œ (256 color palette)
# ============================================================

HEADER

    # ì „ê²½ìƒ‰ ì½”ë“œ ì €ìž¥
    echo "# Foreground color codes" >> "$CUSTOM_COLOR_FILE"
    for i in "${!FG_VARS[@]}"; do
        echo "${FG_VARS[$i]}_CODE=${FG_VALUES[$i]}" >> "$CUSTOM_COLOR_FILE"
    done

    echo "" >> "$CUSTOM_COLOR_FILE"

    # ë°°ê²½ìƒ‰ ì½”ë“œ ì €ìž¥
    echo "# Background color codes" >> "$CUSTOM_COLOR_FILE"
    for i in "${!BG_VARS[@]}"; do
        echo "${BG_VARS[$i]}_CODE=${BG_VALUES[$i]}" >> "$CUSTOM_COLOR_FILE"
    done

    # init_colors í•¨ìˆ˜ ìƒì„±
    cat >> "$CUSTOM_COLOR_FILE" << 'INIT_FUNC'

# ============================================================
# ìƒ‰ìƒ ì´ˆê¸°í™” í•¨ìˆ˜ (ê¸°ë³¸ color.sh êµ¬ì¡° ìœ ì§€)
# ============================================================

init_colors() {
    RST=$'\033[0m'

    # Git ìƒíƒœ ìƒ‰ìƒ (ì €ìž¥ëœ ê°’ ì‚¬ìš©)
    C_DIM_STATUS=$'\033[38;5;'"${C_STATUS_CODE}"'m'
    C_BRIGHT_STATUS=$'\033[1;38;5;'"${C_STATUS_CODE}"'m'
    C_DIM_SYNC=$'\033[38;5;'"${C_SYNC_CODE}"'m'
    C_BRIGHT_SYNC=$'\033[1;38;5;'"${C_SYNC_CODE}"'m'

    # Rate limit ìƒ‰ìƒ (ì €ìž¥ëœ ê°’ ì‚¬ìš©)
    C_RATE=$'\033[38;5;'"${C_RATE_CODE}"'m'
    C_BURN=$'\033[38;5;'"${C_BURN_CODE}"'m'
    C_TIME=$'\033[38;5;'"${C_TIME_CODE}"'m'

    # ì•„ì´ì½˜ ìƒ‰ìƒ
    C_I_BRANCH=$'\033[38;5;'"${C_BRANCH_CODE}"'m'
    C_I_TREE=$'\033[38;5;'"${C_TREE_CODE}"'m'
    C_I_DIR=$'\033[38;5;'"${C_DIR_CODE}"'m'
    C_I_MODEL=$'\033[38;5;'"${C_MODEL_CODE}"'m'
    C_I_STATUS=$'\033[38;5;'"${C_STATUS_CODE}"'m'
    C_I_SYNC=$'\033[38;5;'"${C_SYNC_CODE}"'m'
    C_I_CTX=$'\033[38;5;'"${C_CTX_CODE}"'m'
    C_I_RATE=$'\033[38;5;'"${C_RATE_CODE}"'m'
    C_I_BURN=$'\033[38;5;'"${C_BURN_CODE}"'m'
    C_I_TIME=$'\033[38;5;'"${C_TIME_CODE}"'m'
    C_I_THEME=$'\033[38;5;229m'

    # ë°°ê²½ìƒ‰ (ì €ìž¥ëœ ê°’ ì‚¬ìš©)
    C_BG_BRANCH=$'\033[48;5;'"${C_BG_BRANCH_CODE}"'m'
    C_BG_TREE=$'\033[48;5;'"${C_BG_TREE_CODE}"'m'
    C_BG_DIR=$'\033[48;5;'"${C_BG_DIR_CODE}"'m'
    C_BG_STATUS=$'\033[48;5;'"${C_BG_STATUS_CODE}"'m'
    C_BG_SYNC=$'\033[48;5;'"${C_BG_SYNC_CODE}"'m'
    C_BG_MODEL=$'\033[48;5;'"${C_BG_MODEL_CODE}"'m'
    C_BG_RATE=$'\033[48;5;58m'
    C_BG_TIME=$'\033[48;5;24m'
    C_BG_BURN=$'\033[48;5;94m'
    C_BG_CTX=$'\033[48;5;22m'
    C_BG_CTX_WARN=$'\033[48;5;94m'
    C_BG_CTX_CRIT=$'\033[48;5;52m'

    # ë°•ìŠ¤/ì¹© í…Œë‘ë¦¬ (ê³ ì •)
    C_BOX=$'\033[38;5;240m'
    C_CHIP=$'\033[38;5;245m'

    # ì¹©/ì¹´ë“œ ë°°ê²½ìƒ‰
    C_BG_LOC=$'\033[48;5;'"${C_BG_LOC_CODE}"'m'
    C_BG_GIT=$'\033[48;5;'"${C_BG_GIT_CODE}"'m'
    C_BG_SES=$'\033[48;5;'"${C_BG_SES_CODE}"'m'
    C_BG=$'\033[48;5;235m'

    # ë°°í„°ë¦¬ ë°°ê²½ìƒ‰ (ê³ ì •)
    C_BAT_EMPTY=$'\033[48;5;236m'
    C_BAT_GREEN=$'\033[48;5;23m'
    C_BAT_YELLOW=$'\033[48;5;94m'
    C_BAT_RED=$'\033[48;5;52m'

    # ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ë™ì  ìƒ‰ìƒ
    if [[ "$CONTEXT_PCT" -ge 70 ]]; then
        # ìœ„í—˜: ë°ì€ ìƒ‰ìƒ
        C_BRANCH=$'\033[1;38;5;'"${C_BRANCH_CODE}"'m'
        C_TREE=$'\033[1;38;5;'"${C_TREE_CODE}"'m'
        C_DIR=$'\033[1;38;5;'"${C_DIR_CODE}"'m'
        C_MODEL=$'\033[1;38;5;'"${C_MODEL_CODE}"'m'
        C_STATUS=$'\033[1;38;5;'"${C_STATUS_CODE}"'m'
        C_SYNC=$'\033[1;38;5;'"${C_SYNC_CODE}"'m'
        C_CTX=$'\033[1;91m'
        C_CTX_TEXT=$'\033[1;91m'
        CTX_ICON="${ICON_CTX_CRIT:-ðŸ”¥}"
        C_BAT_FILL="$C_BAT_RED"
    elif [[ "$CONTEXT_PCT" -ge 50 ]]; then
        # ê²½ê³ : ì¤‘ê°„ ë°ê¸°
        C_BRANCH=$'\033[1;38;5;'"${C_BRANCH_CODE}"'m'
        C_TREE=$'\033[1;38;5;'"${C_TREE_CODE}"'m'
        C_DIR=$'\033[1;38;5;'"${C_DIR_CODE}"'m'
        C_MODEL=$'\033[1;38;5;'"${C_MODEL_CODE}"'m'
        C_STATUS=$'\033[1;38;5;'"${C_STATUS_CODE}"'m'
        C_SYNC=$'\033[1;38;5;'"${C_SYNC_CODE}"'m'
        C_CTX=$'\033[1;38;5;208m'
        C_CTX_TEXT=$'\033[1;38;5;208m'
        CTX_ICON="${ICON_CTX_WARN:-ðŸª«}"
        C_BAT_FILL="$C_BAT_YELLOW"
    else
        # ì •ìƒ: ê¸°ë³¸ ìƒ‰ìƒ
        C_BRANCH=$'\033[38;5;'"${C_BRANCH_CODE}"'m'
        C_TREE=$'\033[38;5;'"${C_TREE_CODE}"'m'
        C_DIR=$'\033[38;5;'"${C_DIR_CODE}"'m'
        C_MODEL=$'\033[38;5;'"${C_MODEL_CODE}"'m'
        C_STATUS=$'\033[38;5;'"${C_STATUS_CODE}"'m'
        C_SYNC=$'\033[38;5;'"${C_SYNC_CODE}"'m'
        C_CTX=$'\033[38;5;'"${C_CTX_CODE}"'m'
        C_CTX_TEXT=$'\033[0m'
        CTX_ICON="${ICON_CTX_NORM:-ðŸ”‹}"
        C_BAT_FILL="$C_BAT_GREEN"
    fi
}

# Rate limit ë™ì  ìƒ‰ìƒ
get_rate_color() {
    if [[ "$RATE_LIMIT_PCT" -ge 80 ]]; then
        echo $'\033[1;91m'
    elif [[ "$RATE_LIMIT_PCT" -ge 50 ]]; then
        echo $'\033[1;38;5;208m'
    else
        echo $'\033[38;5;'"${C_RATE_CODE}"'m'
    fi
}
INIT_FUNC

    # ë³€ê²½ í”Œëž˜ê·¸ í•´ì œ
    MODIFIED=false

    # ì„±ê³µ ë©”ì‹œì§€
    show_save_message
}

# ============================================================
# ì €ìž¥ ì™„ë£Œ ë©”ì‹œì§€
# ============================================================

show_save_message() {
    local y=$(($(tput lines) - 4))
    tput cup $y 2

    echo -e "\033[1;32mâœ“ Saved to $CUSTOM_COLOR_FILE\033[0m"
    echo -e "  \033[2mApply with: export CLAUDE_THEME=custom-2line\033[0m"

    sleep 1.5
}
